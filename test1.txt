-- --------------------------------------------------------------------------------
-- Routine DDL
-- Note: comments before and after the routine body will not be stored by the server
-- --------------------------------------------------------------------------------
DELIMITER $$

CREATE PROCEDURE `worksmanagement_melbourne_dev`.`pro_planning_to_assembly` (IN inPlanningId INT)
BEGIN

    /* variable declarations section */
	DECLARE var_calculated_total INT;
    DECLARE cur_var_task_to_assembly_id INT;

    DECLARE no_more_rows INT;  

    /* cursor declaration section */
    /* ids in temp table */
    DECLARE cursor_task_to_assembly CURSOR FOR
        SELECT id
        FROM tmp_planning_to_assembly;

    /* handler declaration section */
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET no_more_rows = TRUE;

    /* processing section */

	/* start with v_task_to_assembly view for the given task id - and add a total column */
    /* create a temporary table to hold the result set */
	DROP TEMPORARY TABLE IF EXISTS tmp_planning_to_assembly;
	CREATE TEMPORARY TABLE tmp_planning_to_assembly (calculated_total INT)
		SELECT t.*
		FROM v_task_to_assembly t
			JOIN tbl_planning planning ON t.task_id = planning.id
		WHERE planning.lft >= (SELECT tbl_planning.lft FROM tbl_planning WHERE tbl_planning.id = inPlanningId)
			AND planning.rgt <= (SELECT tbl_planning.rgt FROM tbl_planning WHERE tbl_planning.id = inPlanningId);

    /* add the custom field columns to the temporary table */
    /* loop thru custom fields */
    OPEN cursor_task_to_assembly;
    loop_task_to_assembly: LOOP
        FETCH cursor_task_to_assembly INTO cur_var_task_to_assembly_id;
        IF no_more_rows THEN
            SET no_more_rows = FALSE;
            CLOSE cursor_task_to_assembly;
            LEAVE loop_task_to_assembly;
        END IF;

		/* get the total for this id */
		CALL pro_task_to_assembly_assembly_quantity_total(cur_var_task_to_assembly_id, var_calculated_total);

        /* update the caluculated quantity into the temp table */
        UPDATE tmp_planning_to_assembly SET calculated_total = var_calculated_total WHERE id = cur_var_task_to_assembly_id;

    END LOOP; /* end loop thru custom fields */

END