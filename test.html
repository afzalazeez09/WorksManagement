-- --------------------------------------------------------------------------------
-- Routine DDL
-- Note: comments before and after the routine body will not be stored by the server
-- --------------------------------------------------------------------------------
DELIMITER $$

CREATE PROCEDURE `pro_get_tasks_from_crew_admin_view` (IN in_id INT)
/*
@return a recordset of tasks with appended a columns for each generic related generic type as determined by flag in custom field to task template
@param in_id - id of parent item in wbs
@param in_level - a work breakdown structure level (1=project, 2=day, 3=crew, 4 = task)
*/
BEGIN

    /* variable declarations section */
    DECLARE cur_var_task_id INT;
    DECLARE cur_var_custom_field_description TEXT;
    DECLARE cur_var_custom_field_data_type INT;
    DECLARE cur_var_custom_value_date DATE;
    DECLARE cur_var_custom_value_float FLOAT;
    DECLARE cur_var_custom_value_int INT;
    DECLARE cur_var_custom_value_text TEXT;
    DECLARE cur_var_custom_value_time TIME;

    DECLARE no_more_rows INT;  
    DECLARE var_custom_value TEXT;

    /* cursor declaration section */
    /* get a list of column names to append to task columns in returned set */
    DECLARE cursor_custom_field CURSOR FOR 
        SELECT DISTINCT tbl_custom_field.description
        FROM tbl_task_temp
        JOIN tbl_task_to_custom_field_to_task_template ON tbl_task_temp.id = tbl_task_to_custom_field_to_task_template.task_id
        JOIN tbl_custom_field_to_task_template ON tbl_task_to_custom_field_to_task_template.custom_field_to_task_template_id = tbl_custom_field_to_task_template.id
        JOIN tbl_custom_field ON tbl_custom_field_to_task_template.custom_field_id = tbl_custom_field.id
        WHERE tbl_custom_field_to_task_template.show_in_planning = 1;

    /* get a list of generic items relevant for all the selected tasks */
    DECLARE cursor_custom_value CURSOR FOR 
        SELECT tbl_task_temp.id, tbl_custom_field.description, tbl_custom_field.data_type, tbl_custom_value.type_date, tbl_custom_value.type_float, tbl_custom_value.type_int, tbl_custom_value.type_text, tbl_custom_value.type_time
        FROM tbl_task_temp
		JOIN tbl_task_to_custom_field_to_task_template ON tbl_task_temp.id = tbl_task_to_custom_field_to_task_template.task_id
        JOIN tbl_custom_field_to_task_template ON tbl_task_to_custom_field_to_task_template.custom_field_to_task_template_id = tbl_custom_field_to_task_template.id
        JOIN tbl_custom_field ON tbl_custom_field_to_task_template.custom_field_id = tbl_custom_field.id
        JOIN tbl_custom_value ON tbl_task_to_custom_field_to_task_template.customValue_id = tbl_custom_value.id
		WHERE tbl_custom_field_to_task_template.show_in_planning = 1;

    /* handler declaration section */
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET no_more_rows = TRUE;

    /* processing section */

	/* obtain a list of tasks from the in params - because planning table is nested set we can retrieve these in a single query */
    /* create a temorary table to hold the result set */
	DROP TEMPORARY TABLE IF EXISTS tbl_task_temp;
	CREATE TEMPORARY TABLE tbl_task_temp
	SELECT
		t.id AS id,
		t.task_template_id,
		t.quantity,
		t.location,
		COALESCE(t.planned, project.planned) AS planned,
		(SELECT `date` FROM tbl_working_days WHERE id = (SELECT id + MAX( lead_in_days ) FROM tbl_working_days WHERE `date` >= t.planned LIMIT 1)) as searchEarliest,
		t.preferred_mon,
		t.preferred_tue,
		t.preferred_wed,
		t.preferred_thu,
		t.preferred_fri,
		t.preferred_sat,
		t.preferred_sun,
		CONCAT_WS(in_delimiter,
			contact.first_name,
			contact.last_name,
			contact.email
			) AS searchInCharge,
		CONCAT_WS(in_delimiter,
			taskTemplate.description
			) AS searchTaskTemplate
	FROM tbl_planning id0
		JOIN tbl_task t USING(id)
		LEFT JOIN tbl_duty duty ON t.id = duty.task_id
		LEFT JOIN tbl_duty_step dutyStep ON duty.duty_step_id = dutyStep.id
		LEFT JOIN tbl_project project ON t.project_id = project.id
		LEFT JOIN tbl_user inCharge ON planning.in_charge_id = inCharge.id,
		LEFT JOIN tbl_contact contact ON inCharge.contact_id = contact.id,
		LEFT JOIN tbl_task_template taskTemplate ON t.task_template_id = taskTemplate.id
	WHERE tbl_planning.`level` = 4
		AND tbl_planning.lft >= (SELECT tbl_planning.lft FROM tbl_planning WHERE tbl_planning.id = in_id)
		AND tbl_planning.rgt<= (SELECT tbl_planning.rgt FROM tbl_planning WHERE tbl_planning.id = in_id);

    /* add the custom field columns to the temporary table */
    /* loop thru custom fields */
    OPEN cursor_custom_field;
    loop_custom_field: LOOP
        FETCH cursor_custom_field INTO cur_var_custom_field_description;
        IF no_more_rows THEN
            set no_more_rows = false;
            CLOSE cursor_custom_field;
            LEAVE loop_custom_field;
        END IF;

        /* add the column to the temporary table */
        SET @stmt_add_column = CONCAT('ALTER TABLE `tbl_task_temp` ADD COLUMN ', cur_var_custom_field_description, ' TEXT');

        PREPARE STMT FROM @stmt_add_column;
        EXECUTE STMT;
    END LOOP; /* end loop thru custom fields */

    /* loop thru custom values */
    OPEN cursor_custom_value;
    loop_custom_value: LOOP

        FETCH cursor_custom_value INTO
            cur_var_task_id,
            cur_var_custom_field_description,
            cur_var_custom_field_data_type,
            cur_var_custom_value_date,
            cur_var_custom_value_float,
            cur_var_custom_value_int,
            cur_var_custom_value_text,
            cur_var_custom_value_time;

        IF no_more_rows THEN
            set no_more_rows = false;
            CLOSE cursor_custom_value;
            LEAVE loop_custom_value;
        END IF;

        CASE cur_var_custom_field_data_type
            WHEN 1 THEN SET var_custom_value = cur_var_custom_value_date;
            WHEN 2 THEN SET var_custom_value = cur_var_custom_value_float;
            WHEN 3 THEN SET var_custom_value = cur_var_custom_value_int;
            WHEN 4 THEN SET var_custom_value = cur_var_custom_value_text;
            WHEN 5 THEN SET var_custom_value = cur_var_custom_value_time;
        END CASE;

        /* add the column value to the temporary table */
        SET @stmt_insert_custom_value = CONCAT_WS('', 
            'UPDATE tbl_task_temp SET ', cur_var_custom_field_description, ' = \'', var_custom_value, '\' WHERE tbl_task_temp.id = ', cur_var_task_id);

        PREPARE STMT FROM @stmt_insert_custom_value;
        EXECUTE STMT;

    END LOOP; /* end loop thru custom values*/

    /* send the recordset  */
   SELECT * FROM tbl_task_temp;

    /* clean up for time */
    DROP TEMPORARY TABLE IF EXISTS tbl_task_temp;

END