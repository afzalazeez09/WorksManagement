<!doctype html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" type="text/css" href="/WorksManagement/assets/da909dd9/css/bootstrap.css" />
<link rel="stylesheet" type="text/css" href="/WorksManagement/assets/da909dd9/css/bootstrap-responsive.css" />
<link rel="stylesheet" type="text/css" href="/WorksManagement/assets/da909dd9/css/font-awesome.css" />
<link rel="stylesheet" type="text/css" href="/WorksManagement/assets/da909dd9/css/bootstrap-yii.css" />
<link rel="stylesheet" type="text/css" href="/WorksManagement/assets/da909dd9/css/jquery-ui-bootstrap.css" />
<link rel="stylesheet" type="text/css" href="/WorksManagement/assets/da909dd9/css/bootstrap-notify.css" />
<link rel="stylesheet" type="text/css" href="/WorksManagement/css/client_val_form.css" media="screen" />
<script type="text/javascript" src="/WorksManagement/assets/a2a0ee2d/jquery.js"></script>
<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jqueryui/1.8.24/jquery-ui.min.js"></script>
<script type="text/javascript" src="/WorksManagement/assets/da909dd9/js/bootstrap.bootbox.min.js"></script>
<script type="text/javascript" src="/WorksManagement/assets/da909dd9/js/bootstrap.notify.js"></script>
<script type="text/javascript" src="/WorksManagement/assets/da909dd9/js/bootstrap.js"></script>
<script type="text/javascript" src="/WorksManagement/assets/41f4b99f//jquery.jstree.js"></script>
<script type="text/javascript" src="/WorksManagement/js_plugins/json2/json2.js"></script>
<title>Works Management - Admin Planning</title>

	<meta name="description" content="">
	<meta name="author" content="">
	<meta name="viewport" content="width=device-width">
	<link rel="stylesheet" type="text/css" href="/WorksManagement/themes/base/css/style.css" />
	<link rel="icon" href="/WorksManagement/favicon.ico" type="image/x-icon">
	<link rel="shortcut icon" href="/WorksManagement/favicon.ico" type="image/x-icon">

</head>
<body>

<div class="container">
	<div class="row">
		<header class="span12">

			<div class="navbar-inverse navbar"><div class="navbar-inner"><div class="container"><a class="btn btn-navbar" data-toggle="collapse" data-target="#yii_bootstrap_collapse_0"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></a><a href="#" class="brand">Works Management</a><div class="nav-collapse collapse" id="yii_bootstrap_collapse_0"><ul id="yw1" class="nav"><li><a href="http://localhost/phpmyadmin">Database</a></li></ul><ul class="pull-right nav" id="yw2"><li><a href="/WorksManagement/site/logout">Logout (username)</a></li></ul></div></div></div></div>			
			<!-- breadcrumbs -->
							﻿﻿<ul class="breadcrumbs breadcrumb"><li class="active"><a href="/WorksManagement/">Home</a><span class="divider">/</span></li><li class="active"><a href="/WorksManagement/Client/admin">Clients</a><span class="divider">/</span></li><li class="active"><a href="/WorksManagement/Client/update/8">SP Ausnet</a><span class="divider">/</span></li><li class="active"><a href="/WorksManagement/Project/admin?client_id=8">Projects</a><span class="divider">/</span></li><li class="active"><span data-original-title="SP AusNet Test Project">SP AusNet Test Pr...</span></li></ul>			
			<!-- tabs -->
			<div id="yw3"><ul id="yw4" class="nav nav-tabs"><li data-original-title="SP AusNet Test Project"><a href="/WorksManagement/Project/update/7">SP AusNet Test Pr...</a></li><li><a href="/WorksManagement/Day/admin?project_id=7">Days</a></li><li><a href="/WorksManagement/ProjectToClientContact/admin?project_id=7">Client contacts</a></li><li><a href="/WorksManagement/ProjectToAuthItem/admin?project_id=7">Roles</a></li><li class="active"><a href="/WorksManagement/Planning/admin?project_id=7">Planning</a></li></ul><div class="tab-content"><div id="yw3_tab_1" class="tab-pane fade"></div><div id="yw3_tab_2" class="tab-pane fade"></div><div id="yw3_tab_3" class="tab-pane fade"></div><div id="yw3_tab_4" class="tab-pane fade"></div><div id="yw3_tab_5" class="tab-pane fade active in"></div></div></div>				
			<h2>Planning</h2>		</header>
	</div>
	
	<div class="row">
		<div class="span12">
			<div class="modal fade" id="myModal" style="display: block;"><div class="modal-body" id="form-modal"></div></div><div id="category_admin_tree" ></div>
<script  type="text/javascript">
	$(function ()
	{
		// get the users rights
		writeAccessProject = true;
		writeAccessDay = true;
		writeAccessCrew = true;
		writeAccessTask = true;
		readAccessProject = true;
		readAccessDay = true;
		readAccessCrew = true;
		readAccessTask = true;
		isScheduler = true;
		
					
		function getAction(obj)
		{
			// get target mode level
			id=obj.attr("id").replace("node_","");

			if(obj.is("DIV"))
			{
				level = 1;
			}
			else
			{
				level = obj.find('[class^="level"]').first().attr("class").replace("level","");
			}

			if(level == 1)
			{
				writeAccess = writeAccessProject;
				readAccess = readAccessProject;
				modelName = "Project";
				reportItemsProject = null;
			}
			else if(level == 2)
			{
				writeAccess = writeAccessDay && isScheduler;
				readAccess = readAccessDay;
				modelName = "Day";
				reportItemsProject = null;
			}
			else if(level == 3)
			{
				writeAccess = writeAccessCrew && isScheduler;
				readAccess = readAccessCrew;
				modelName = "Crew";
				reportItemsProject = { reports : { 'label' : 'Reports', 'submenu' : {
								item0 : {
								"label"             : "Daily brief",
								"action"            : function (obj) { window.location = "/WorksManagement/Report/show/1?context=Crew&pk=" + id}
							},item1 : {
								"label"             : "Material take off",
								"action"            : function (obj) { window.location = "/WorksManagement/Report/show/2?context=Crew&pk=" + id}
							}
							}}};
			}
			else if(level == 4)
			{
				writeAccess = writeAccessTask;
				readAccess = readAccessTask;
				modelName = "Task";
				reportItemsProject = null;
			}

			if(writeAccess)
			{
				action = "Update";
			}
			else if(readAccess)
			{
				action = "View";
			}
			else
			{
				action = false;
			}
		}

		$("#category_admin_tree").jstree(
		{
			"html_data" :
				{
				"ajax" :
					{
					"type":"POST",
					"url" : "/WorksManagement/Planning/fetchTree?project_id=7",
					"data" : function (n)
					{
						return{
							id : n.attr ? n.attr("id") : 0,
							"YII_CSRF_TOKEN":"6d514233912700190ae058da8fd6f43df428bbeb"
						};
					}
				}
			},

			"contextmenu":  { 'items': function(obj){
					contextMenu = {};		
					getAction(obj);
					if(action)
					{
						update = {
							"update" : {
								"label"	: action,
								"action" : function (obj) {

									// need to re-read modal contents first as selecting a different record
									$.ajax({
										type: "POST",
										url: "/WorksManagement/Planning/returnForm?project_id=7",
										data:{
											"id":  id,
											"action": action,
											"model_name":  modelName,
											"YII_CSRF_TOKEN":"6d514233912700190ae058da8fd6f43df428bbeb"
										},
										'beforeSend' : function(){
											$("#category_admin_tree").addClass("ajax-sending");
										},
										'complete' : function(){
											$("#category_admin_tree").removeClass("ajax-sending");
										},
										success: function(data){
											// change the contents
											$("#form-modal").html(data);
											formAction = $("#form-modal form[action]").attr('action');
											$("#form-modal form[action]").attr('action', formAction + '?project_id=7');
											// display the modal
											$("#myModal").modal('show');

										} //success
									});//ajax

								}//action function

							}
						};//update
						$.extend(contextMenu, update);

						if(writeAccess)
						{
							remove = {
								"remove" : {
									"label"	: "Delete",
									"action" : function (obj) {

										if(confirm('Are you sure you want to remove ' + (obj).attr('rel') + 'and any sub categories'))
										{
											jQuery("#category_admin_tree").jstree("remove",obj);
										}
									}
								}
							};//remove
							$.extend(contextMenu, remove);

							if(level != 4)
							{
								create = {
									"create" : {
										"label"	: "Create",
										"action" : function (obj) {
											ajaxdata = { "YII_CSRF_TOKEN":"6d514233912700190ae058da8fd6f43df428bbeb" };

											// get the target model name
											if(level == 1)
											{
												targetName = "Day";
												$.extend(ajaxdata, {project_id : id});
											}
											else if(level == 2)
											{
												targetName = "Crew";
												$.extend(ajaxdata, {day_id : id});
											}
											else if(level == 3)
											{
												targetName = "Task";
												$.extend(ajaxdata, {crew_id : id});
											}

											$.extend(ajaxdata, {model_name : targetName});

											// need to re-read modal contents first as selecting a different record
											$.ajax({
												type: "POST",
												url: "/WorksManagement/Planning/returnForm?project_id=7",
												data: ajaxdata,
												'beforeSend' : function(){
													$("#category_admin_tree").addClass("ajax-sending");
												},
												'complete' : function(){
													$("#category_admin_tree").removeClass("ajax-sending");
												},
												success: function(data){
													// change the contents
													$("#form-modal").html(data);
													// display the modal
													$("#myModal").modal('show');

												} //success
											});//ajax

										}//actions
									}
								};
								$.extend(contextMenu, create);
							}//create
						}//if(writeAccess)
					}//if(action)
					
					// add any reports
					if(reportItemsProject !== null)
					{
						$.extend(contextMenu, reportItemsProject);
					}
					
					return contextMenu;
				}//items funtcion
			},//context menu

			// the `plugins` array allows you to configure the active plugins on this instance
			"plugins" : ["themes","html_data","contextmenu","crrm","dnd"],
			// each plugin you have included can have its own config object
			"core" : { "initially_open" : [ 'node_7','node_8','node_9','node_21' ],'open_parents':true},
			// it makes sense to configure a plugin only if overriding the defaults

			// restrict to moving only to correct levels
			"crrm" : {
				move : {
					check_move : function (m) {
						target = m.o.find('[class^="level"]').first().attr("class").replace("level","");

						if(m.np.is("DIV"))
						{
							destination = 1;
						}
						else
						{
							destination = m.np.find('[class^="level"]').first().attr("class").replace("level","");
						}

						return (target - destination) == 1;
					}
				}
			}
		})

		.bind("remove.jstree", function (e, data) {
			$.ajax({
				type:"POST",
				url:"/WorksManagement/Planning/remove?project_id=7",
				data:{
					"id" : data.rslt.obj.attr("id").replace("node_",""),
					"YII_CSRF_TOKEN":"6d514233912700190ae058da8fd6f43df428bbeb"
				},
				beforeSend : function(){
					$("#category_admin_tree").addClass("ajax-sending");
				},
				complete: function(){
					$("#category_admin_tree").removeClass("ajax-sending");
				},
				success:function (r) {  response= $.parseJSON(r);
					if(!response.success) {
						$.jstree.rollback(data.rlbk);
					};
				}
			});
		})

		.bind("move_node.jstree", function (e, data) {
			data.rslt.o.each(function (i) {

				//jstree provides a whole  bunch of properties for the move_node event
				//not all are needed for this view,but they are there if you need them.
				//Commented out logs  are for debugging and exploration of jstree.

				next= jQuery.jstree._reference('#category_admin_tree')._get_next (this, true);
				previous= jQuery.jstree._reference('#category_admin_tree')._get_prev(this,true);

				pos=data.rslt.cp;
				moved_node=$(this).attr('id').replace("node_","");
				next_node=next!=false?$(next).attr('id').replace("node_",""):false;
				previous_node= previous!=false?$(previous).attr('id').replace("node_",""):false;
				new_parent=$(data.rslt.np).attr('id').replace("node_","");
				old_parent=$(data.rslt.op).attr('id').replace("node_","");
				ref_node=$(data.rslt.r).attr('id').replace("node_","");
				ot=data.rslt.ot;
				rt=data.rslt.rt;
				copy= typeof data.rslt.cy!='undefined'?data.rslt.cy:false;
				copied_node= (typeof $(data.rslt.oc).attr('id') !='undefined')? $(data.rslt.oc).attr('id').replace("node_",""):'UNDEFINED';
				new_parent_root=data.rslt.cr!=-1?$(data.rslt.cr).attr('id').replace("node_",""):'root';
				replaced_node= (typeof $(data.rslt.or).attr('id') !='undefined')? $(data.rslt.or).attr('id').replace("node_",""):'UNDEFINED';


				//                      console.log(data.rslt);
				//                      console.log(pos,'POS');
				//                      console.log(previous_node,'PREVIOUS NODE');
				//                      console.log(moved_node,'MOVED_NODE');
				//                      console.log(next_node,'NEXT_NODE');
				//                      console.log(new_parent,'NEW PARENT');
				//                      console.log(old_parent,'OLD PARENT');
				//                      console.log(ref_node,'REFERENCE NODE');
				//                      console.log(ot,'ORIGINAL TREE');
				//                      console.log(rt,'REFERENCE TREE');
				//                      console.log(copy,'IS IT A COPY');
				//                      console.log( copied_node,'COPIED NODE');
				//                      console.log( new_parent_root,'NEW PARENT INCLUDING ROOT');
				//                      console.log(replaced_node,'REPLACED NODE');


				$.ajax({
					async : false,
					type: 'POST',
					url: "/WorksManagement/Planning/moveCopy?project_id=7",

					data : {
						"moved_node" : moved_node,
						"new_parent":new_parent,
						"new_parent_root":new_parent_root,
						"old_parent":old_parent,
						"pos" : pos,
						"previous_node":previous_node,
						"next_node":next_node,
						"copy" : copy,
						"copied_node":copied_node,
						"replaced_node":replaced_node,
						"YII_CSRF_TOKEN":"6d514233912700190ae058da8fd6f43df428bbeb"
					},
					beforeSend : function(){
						$("#category_admin_tree").addClass("ajax-sending");
					},
					complete : function(){
						$("#category_admin_tree").removeClass("ajax-sending");
					},
					success : function (r) {
						response=$.parseJSON(r);
						if(!response.success) {
							$.jstree.rollback(data.rlbk);
							alert(response.message);
						}
						else {
							//if it's a copy
							if  (data.rslt.cy){
								$(data.rslt.oc).attr("id", "node_" + response.id);                         
								if(data.rslt.cy && $(data.rslt.oc).children("UL").length) {
									data.inst.refresh(data.inst._get_parent(data.rslt.oc));
								}
							}
						}

					}
				}); //ajax

			});//each function
		});   //bind move event

		;//JSTREE FINALLY ENDS (PHEW!)

		$("#reload").click(function ()
		{
			jQuery("#category_admin_tree").jstree("refresh");
		});

		$("#category_admin_tree").delegate("a","click", function(e) {
//TODO: make this a function as exact repeat of above - pass in object and return the other required variables
			// get target mode level
			getAction($(this).parent());

			if(action)
			{
				// go to the admin screen - filtering by this parent id
				window.location = encodeURI("/WorksManagement/" + modelName + "/" + action + "/" + id + "?project_id=7");
			}
			
		});

	});

</script>
<br><a class="btn btn-primary btn-small" id="yw0" href="/WorksManagement/Planning/addDay?project_id=7">New day</a>		</div>
	</div>

</div>
	
<script type="text/javascript">
/*<![CDATA[*/
jQuery(function($) {
jQuery('body').tooltip({'selector':'[rel=tooltip]'});
jQuery('body').popover({'selector':'[rel=popover]'});
jQuery('#yii_bootstrap_collapse_0').collapse({'parent':false,'toggle':false});
jQuery('#yw3').tab('show');
});
/*]]>*/
</script>
</body>
</html>