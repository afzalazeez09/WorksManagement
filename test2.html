-- --------------------------------------------------------------------------------
-- Routine DDL
-- Note: comments before and after the routine body will not be stored by the server
-- --------------------------------------------------------------------------------
DELIMITER $$

CREATE PROCEDURE `worksmanagement_melbourne_dev`.`pro_task_to_assembly` (IN iTaskId INT)
BEGIN

    /* variable declarations section */
	DECLARE var_calculated_total INT;
    DECLARE cur_var_task_to_assembly_id INT;

    DECLARE no_more_rows INT;  

    /* cursor declaration section */
    /* ids in temp table */
    DECLARE cursor_task_to_assembly CURSOR FOR
        SELECT id
        FROM tmp_table;

    /* handler declaration section */
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET no_more_rows = TRUE;

    /* processing section */

	/* start with v_task_to_assembly view for the given task id - and add a total column */
    /* create a temporary table to hold the result set */
	DROP TEMPORARY TABLE IF EXISTS tmp_table;
	CREATE TEMPORARY TABLE tmp_table (calculated_total INT), SELECT * FROM v_task_to_assembly WHERE task_id = iTaskId;

    /* add the custom field columns to the temporary table */
    /* loop thru custom fields */
    OPEN cursor_task_to_assembly;
    loop_task_to_assembly: LOOP
        FETCH cursor_task_to_assembly INTO cur_var_task_to_assembly_id;
        IF no_more_rows THEN
            SET no_more_rows = FALSE;
            CLOSE cursor_task_to_assembly;
            LEAVE loop_task_to_assembly:;
        END IF;

		/* get the total for this id */
		pro_task_to_assembly_assembly_quantity_total` (IN iNumber INT, OUT oTotal INT);

        /* add the column to the temporary table */
        UPDATE ;

        PREPARE STMT FROM @stmt_add_column;
        EXECUTE STMT;
    END LOOP; /* end loop thru custom fields */

	/* ouput recordset */
	SELECT * FROM tmp_table;


END