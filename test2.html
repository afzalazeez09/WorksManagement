-- --------------------------------------------------------------------------------
-- Routine DDL
-- Note: comments before and after the routine body will not be stored by the server
-- --------------------------------------------------------------------------------
DELIMITER $$

CREATE PROCEDURE `worksmanagement_melbourne_dev`.`pro_planning_to_material` (IN inPlanningId INT)
BEGIN

    /* variable declarations section */
	DECLARE var_accumulated_total INT;
    DECLARE cur_var_task_to_material_id INT;

    DECLARE no_more_rows INT;  

    /* cursor declaration section */
    /* ids in temp table */
    DECLARE cursor_task_to_material CURSOR FOR
        SELECT id
        FROM tmp_planning_to_material;

    /* handler declaration section */
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET no_more_rows = TRUE;

    /* processing section */

	/* start with v_task_to_material view for the given task id - and add a total column */
    /* create a temporary table to hold the result set */
	DROP TEMPORARY TABLE IF EXISTS tmp_planning_to_material;
	CREATE TEMPORARY TABLE tmp_planning_to_material (accumulated_total INT)
		SELECT t.*
		FROM v_task_to_material t
			JOIN tbl_planning planning ON t.task_id = planning.id
		WHERE planning.lft >= (SELECT tbl_planning.lft FROM tbl_planning WHERE tbl_planning.id = inPlanningId)
			AND planning.rgt <= (SELECT tbl_planning.rgt FROM tbl_planning WHERE tbl_planning.id = inPlanningId);

    /* add the custom field columns to the temporary table */
    /* loop thru custom fields */
    OPEN cursor_task_to_material;
    loop_task_to_material: LOOP
        FETCH cursor_task_to_material INTO cur_var_task_to_material_id;
        IF no_more_rows THEN
            SET no_more_rows = FALSE;
            CLOSE cursor_task_to_material;
            LEAVE loop_task_to_material;
        END IF;

		/* get the total for this id */
		CALL pro_task_to_material_material_quantity_total(cur_var_task_to_material_id, var_accumulated_total);

        /* update the calculated quantity into the temp table */
        UPDATE tmp_planning_to_material SET accumulated_total = var_accumulated_total WHERE id = cur_var_task_to_material_id;

    END LOOP; /* end loop thru custom fields */

END